<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KKTP Generator SD - Kurikulum Merdeka</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel untuk compile JSX di browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Font & Style Tambahan -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            .page-break { page-break-before: always; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // KONFIGURASI DAN ICONS
        // ==========================================
        
        // API Key Anda (Sesuai permintaan)
        const apiKey = "AIzaSyATNPjYf4LOAl9vuEt4fbKlHC4h6ppUikw";

        // Definisi Icon Sederhana (Pengganti Lucide-React agar jalan di HTML biasa)
        const Icon = ({ path, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            FileText: (props) => <Icon {...props} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>} />,
            User: (props) => <Icon {...props} path={<><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
            BookOpen: (props) => <Icon {...props} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />,
            List: (props) => <Icon {...props} path={<><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></>} />,
            Printer: (props) => <Icon {...props} path={<><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></>} />,
            Plus: (props) => <Icon {...props} path={<><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>} />,
            Trash2: (props) => <Icon {...props} path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />,
            Sparkles: (props) => <Icon {...props} path={<><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3z"/></>} />,
            ChevronRight: (props) => <Icon {...props} path={<polyline points="9 18 15 12 9 6"/>} />,
            ChevronLeft: (props) => <Icon {...props} path={<polyline points="15 18 9 12 15 6"/>} />,
            Check: (props) => <Icon {...props} path={<polyline points="20 6 9 17 4 12"/>} />,
            AlertCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} />,
            Loader2: (props) => <Icon {...props} className={`animate-spin ${props.className || ''}`} path={<><path d="M21 12a9 9 0 1 1-6.219-8.56"/></>} />,
            Save: (props) => <Icon {...props} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />,
            FileDown: (props) => <Icon {...props} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="m9 15 3 3 3-3"/></>} />,
            Mail: (props) => <Icon {...props} path={<><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></>} />,
            AlertTriangle: (props) => <Icon {...props} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></>} />
        };

        const { useState, useEffect, useRef } = React;

        // ==========================================
        // KOMPONEN UTAMA
        // ==========================================
        const App = () => {
            const [step, setStep] = useState(1);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const previewRef = useRef(null);

            // Data State
            const [formData, setFormData] = useState({
                guru: '',
                nipGuru: '',
                kepalaSekolah: '',
                nipKepalaSekolah: '',
                sekolah: '',
                kelas: 'IV',
                mapel: 'Bahasa Indonesia',
                fase: 'B',
                semester: '1',
                jenisGuru: 'Guru Kelas',
                cp: '',
                tp: '',
                pendekatan: 'rubrik'
            });

            const [criteria, setCriteria] = useState([
                { id: 1, text: '', deskripsi_memadai: '', rubrik_mahir: '', rubrik_cakap: '', rubrik_layak: '', rubrik_awal: '' }
            ]);

            // Handlers
            const handleChange = (e) => {
                setFormData({ ...formData, [e.target.name]: e.target.value });
            };

            const handleCriteriaChange = (id, field, value) => {
                setCriteria(criteria.map(c => c.id === id ? { ...c, [field]: value } : c));
            };

            const addRow = () => {
                setCriteria([...criteria, { 
                id: Date.now(), 
                text: '', 
                deskripsi_memadai: 'Peserta didik mampu...', 
                rubrik_mahir: '', 
                rubrik_cakap: '', 
                rubrik_layak: '', 
                rubrik_awal: '' 
                }]);
            };

            const removeRow = (id) => {
                if (criteria.length > 1) {
                setCriteria(criteria.filter(c => c.id !== id));
                }
            };

            // Load Script Helper
            const loadScript = (src) => {
                return new Promise((resolve, reject) => {
                if (document.querySelector(`script[src="${src}"]`)) {
                    resolve();
                    return;
                }
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
                });
            };

            // PDF Download
            const handleDownloadPDF = async () => {
                setLoading(true);
                try {
                    await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js');
                    const element = previewRef.current;
                    const opt = {
                        margin: [10, 10, 10, 10],
                        filename: `KKTP_${formData.mapel.replace(/\s+/g, '_')}_${formData.kelas}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2, useCORS: true },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };

                    if (window.html2pdf) {
                        await window.html2pdf().set(opt).from(element).save();
                    } else {
                        throw new Error('Library PDF gagal dimuat.');
                    }
                } catch (err) {
                    console.error(err);
                    setError("Gagal membuat PDF otomatis. Gunakan tombol 'Cetak' -> 'Simpan sebagai PDF'.");
                } finally {
                    setLoading(false);
                }
            };

            const handlePrint = () => {
                window.print();
            };

            // Docx Export
            const exportToDocx = () => {
                if (!previewRef.current) return;
                const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export HTML to Word</title></head><body>";
                const footer = "</body></html>";
                const sourceHTML = header + previewRef.current.innerHTML + footer;
                const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
                const fileDownload = document.createElement("a");
                document.body.appendChild(fileDownload);
                fileDownload.href = source;
                fileDownload.download = `KKTP_${formData.mapel}_${formData.kelas}.doc`;
                fileDownload.click();
                document.body.removeChild(fileDownload);
            };

            // AI Generation
            const generateWithAI = async () => {
                if (!apiKey) {
                    setError("API Key belum diisi. Silakan edit file index.html dan masukkan API Key Google Gemini Anda.");
                    return;
                }
                if (!formData.tp) {
                    setError("Mohon isi Tujuan Pembelajaran (TP) terlebih dahulu.");
                    return;
                }
                
                setLoading(true);
                setError(null);

                const promptText = `
                Bertindaklah sebagai ahli kurikulum SD (Sekolah Dasar) Indonesia.
                Saya butuh daftar kriteria ketercapaian tujuan pembelajaran (KKTP) berdasarkan Panduan Pembelajaran dan Asesmen Revisi 2025.
                
                Konteks:
                - Mapel: ${formData.mapel}
                - Kelas: ${formData.kelas}
                - Capaian Pembelajaran (CP): "${formData.cp}"
                - Tujuan Pembelajaran (TP): "${formData.tp}"
                - Pendekatan: ${formData.pendekatan}

                Tugas:
                Buatkan 3 sampai 5 indikator/kriteria spesifik.
                
                Format Output JSON MURNI (Array of Objects):
                [
                    {
                    "text": "Isi kriteria/indikator disini",
                    "deskripsi_memadai": "Isi deskripsi jika memadai (hanya untuk pendekatan deskripsi/persentase)",
                    "rubrik_mahir": "Deskripsi Mahir (hanya untuk pendekatan rubrik)",
                    "rubrik_cakap": "Deskripsi Cakap (hanya untuk pendekatan rubrik)",
                    "rubrik_layak": "Deskripsi Layak (hanya untuk pendekatan rubrik)",
                    "rubrik_awal": "Deskripsi Awal Berkembang (hanya untuk pendekatan rubrik)"
                    }
                ]
                
                JANGAN tambahkan markdown code block, berikan raw string JSON saja. Pastikan bahasa Indonesia yang digunakan baku dan sesuai taksonomi Bloom.
                `;

                try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                    contents: [{ parts: [{ text: promptText }] }]
                    })
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error.message || "Terjadi kesalahan API");

                const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!rawText) throw new Error("Gagal mendapatkan respons AI");

                const cleanJson = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                const generatedData = JSON.parse(cleanJson);

                const newCriteria = generatedData.map((item, index) => ({
                    id: Date.now() + index,
                    text: item.text || "Indikator",
                    deskripsi_memadai: item.deskripsi_memadai || "",
                    rubrik_mahir: item.rubrik_mahir || "",
                    rubrik_cakap: item.rubrik_cakap || "",
                    rubrik_layak: item.rubrik_layak || "",
                    rubrik_awal: item.rubrik_awal || ""
                }));

                setCriteria(newCriteria);

                } catch (err) {
                console.error(err);
                setError("Gagal generate. Periksa koneksi internet atau kuota API Key.");
                } finally {
                setLoading(false);
                }
            };

            const Steps = () => (
                <div className="flex justify-between mb-8 relative px-4 no-print">
                <div className="absolute top-1/2 left-0 w-full h-1 bg-gray-200 -z-10 transform -translate-y-1/2"></div>
                {[1, 2, 3, 4].map((s) => (
                    <div key={s} className={`flex flex-col items-center cursor-pointer`} onClick={() => setStep(s)}>
                    <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm transition-all duration-300 ${step >= s ? 'bg-blue-600 text-white shadow-lg scale-110' : 'bg-gray-200 text-gray-500'}`}>
                        {s === 4 ? <Icons.Printer size={18} /> : s}
                    </div>
                    <span className="text-xs mt-2 font-medium hidden sm:block bg-white px-1">
                        {s === 1 ? 'Identitas' : s === 2 ? 'Informasi TP' : s === 3 ? 'Kriteria' : 'Preview'}
                    </span>
                    </div>
                ))}
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col">
                
                {/* Header */}
                <header className="bg-white border-b border-gray-200 sticky top-0 z-50 no-print">
                    <div className="max-w-6xl mx-auto px-4 py-4 flex flex-col md:flex-row items-center justify-between gap-4">
                    <div className="flex items-center gap-3 self-start md:self-auto">
                        <div className="bg-blue-600 p-2 rounded-lg text-white">
                        <Icons.FileText size={24} />
                        </div>
                        <div>
                        <h1 className="text-xl font-bold text-gray-900 leading-tight">KKTP Generator SD</h1>
                        <p className="text-xs text-gray-500">Panduan Pembelajaran & Asesmen (Revisi 2025)</p>
                        </div>
                    </div>
                    
                    <div className="flex flex-wrap gap-2 w-full md:w-auto justify-end">
                        {step === 4 && (
                        <>
                            <button onClick={exportToDocx} className="flex-1 md:flex-none flex items-center justify-center gap-2 bg-green-600 text-white px-3 py-2 rounded-lg hover:bg-green-700 transition-colors shadow-sm text-xs md:text-sm">
                            <Icons.FileDown size={16} />
                            <span>Save Docx</span>
                            </button>
                            
                            <button onClick={handleDownloadPDF} disabled={loading} className="flex-1 md:flex-none flex items-center justify-center gap-2 bg-red-600 text-white px-3 py-2 rounded-lg hover:bg-red-700 transition-colors shadow-sm text-xs md:text-sm disabled:opacity-50">
                            {loading ? <Icons.Loader2 size={16} className="animate-spin" /> : <Icons.FileDown size={16} />}
                            <span>Save PDF</span>
                            </button>

                            <button onClick={handlePrint} className="flex-1 md:flex-none flex items-center justify-center gap-2 bg-slate-800 text-white px-3 py-2 rounded-lg hover:bg-slate-700 transition-colors shadow-sm text-xs md:text-sm">
                            <Icons.Printer size={16} />
                            <span>Cetak</span>
                            </button>
                        </>
                        )}
                    </div>
                    </div>
                </header>

                <main className="flex-grow max-w-5xl mx-auto px-4 py-8 w-full">
                    <Steps />

                    <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden min-h-[500px] print:shadow-none print:border-none print:w-full">
                    
                    {/* Step 1 */}
                    {step === 1 && (
                        <div className="p-6 sm:p-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                        <h2 className="text-2xl font-bold mb-6 flex items-center gap-2 text-blue-800">
                            <Icons.User className="text-blue-500" /> Identitas Modul
                        </h2>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div className="space-y-2">
                            <label className="text-sm font-semibold text-gray-700">Jenis Guru</label>
                            <select name="jenisGuru" value={formData.jenisGuru} onChange={handleChange} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                <option value="Guru Kelas">Guru Kelas</option>
                                <option value="Guru Mata Pelajaran">Guru Mata Pelajaran</option>
                            </select>
                            </div>
                            <div className="space-y-2">
                            <label className="text-sm font-semibold text-gray-700">Satuan Pendidikan</label>
                            <input type="text" name="sekolah" value={formData.sekolah} onChange={handleChange} placeholder="Contoh: SDN 1 Merdeka" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div className="space-y-2">
                            <label className="text-sm font-semibold text-gray-700">Nama Guru</label>
                            <input type="text" name="guru" value={formData.guru} onChange={handleChange} placeholder="Contoh: Budi Santoso, S.Pd." className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
                            </div>
                            <div className="space-y-2">
                            <label className="text-sm font-semibold text-gray-700">NIP Guru</label>
                            <input type="text" name="nipGuru" value={formData.nipGuru} onChange={handleChange} placeholder="Contoh: 19800101 200501 1 001" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div className="space-y-2">
                            <label className="text-sm font-semibold text-gray-700">Nama Kepala Sekolah</label>
                            <input type="text" name="kepalaSekolah" value={formData.kepalaSekolah} onChange={handleChange} placeholder="Contoh: Siti Aminah, M.Pd." className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
                            </div>
                            <div className="space-y-2">
                            <label className="text-sm font-semibold text-gray-700">NIP Kepala Sekolah</label>
                            <input type="text" name="nipKepalaSekolah" value={formData.nipKepalaSekolah} onChange={handleChange} placeholder="Contoh: 19750505 200003 2 005" className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="grid grid-cols-2 gap-4">
                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-gray-700">Kelas</label>
                                <select name="kelas" value={formData.kelas} onChange={handleChange} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                {['I', 'II', 'III', 'IV', 'V', 'VI'].map(k => <option key={k} value={k}>{k}</option>)}
                                </select>
                            </div>
                            <div className="space-y-2">
                                <label className="text-sm font-semibold text-gray-700">Fase</label>
                                <select name="fase" value={formData.fase} onChange={handleChange} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                <option value="A">A (Kelas 1-2)</option>
                                <option value="B">B (Kelas 3-4)</option>
                                <option value="C">C (Kelas 5-6)</option>
                                </select>
                            </div>
                            </div>
                            <div className="space-y-2">
                            <label className="text-sm font-semibold text-gray-700">Mata Pelajaran</label>
                            <input type="text" name="mapel" value={formData.mapel} onChange={handleChange} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
                            </div>
                            <div className="space-y-2">
                            <label className="text-sm font-semibold text-gray-700">Semester</label>
                            <select name="semester" value={formData.semester} onChange={handleChange} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                <option value="1">1 (Ganjil)</option>
                                <option value="2">2 (Genap)</option>
                            </select>
                            </div>
                        </div>
                        </div>
                    )}

                    {/* Step 2 */}
                    {step === 2 && (
                        <div className="p-6 sm:p-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                        <h2 className="text-2xl font-bold mb-6 flex items-center gap-2 text-blue-800">
                            <Icons.BookOpen className="text-blue-500" /> Informasi CP & TP
                        </h2>
                        
                        <div className="space-y-6">
                            <div className="space-y-2">
                            <label className="text-sm font-semibold text-gray-700">Capaian Pembelajaran (CP)</label>
                            <p className="text-xs text-gray-500 mb-1">Salin CP sesuai fase.</p>
                            <textarea name="cp" value={formData.cp} onChange={handleChange} rows={3} placeholder="Contoh: Peserta didik mampu menunjukkan keterampilan..." className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
                            </div>

                            <div className="space-y-2">
                            <label className="text-sm font-semibold text-gray-700">Tujuan Pembelajaran (TP)</label>
                            <p className="text-xs text-gray-500 mb-1">Salin TP dari ATP atau Modul Ajar.</p>
                            <textarea name="tp" value={formData.tp} onChange={handleChange} rows={4} placeholder="Contoh: Peserta didik mampu mengidentifikasi ide pokok dan ide pendukung dari teks deskripsi..." className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
                            </div>

                            <div className="space-y-2">
                            <label className="text-sm font-semibold text-gray-700">Pilih Pendekatan KKTP (PPA 2025)</label>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                {[
                                { id: 'deskripsi', label: 'Deskripsi Kriteria', desc: 'Ceklis memadai/tidak memadai' },
                                { id: 'rubrik', label: 'Rubrik', desc: '4 tingkatan kualitas' },
                                { id: 'interval', label: 'Interval Nilai', desc: 'Rentang nilai & tindak lanjut' },
                                { id: 'persentase', label: 'Persentase', desc: 'Hitungan % ketercapaian' }
                                ].map((opt) => (
                                <div key={opt.id} onClick={() => setFormData({ ...formData, pendekatan: opt.id })} className={`cursor-pointer border-2 rounded-xl p-4 transition-all hover:shadow-md ${formData.pendekatan === opt.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-blue-200'}`}>
                                    <div className="flex justify-between items-center mb-1">
                                    <span className="font-bold text-gray-800 text-sm">{opt.label}</span>
                                    {formData.pendekatan === opt.id && <Icons.Check size={18} className="text-blue-600" />}
                                    </div>
                                    <p className="text-xs text-gray-500">{opt.desc}</p>
                                </div>
                                ))}
                            </div>
                            </div>
                        </div>
                        </div>
                    )}

                    {/* Step 3 */}
                    {step === 3 && (
                        <div className="p-6 sm:p-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                            <h2 className="text-2xl font-bold flex items-center gap-2 text-blue-800">
                            <Icons.List className="text-blue-500" /> Susun Kriteria
                            </h2>
                            <div className="flex gap-2 w-full md:w-auto">
                            <button onClick={generateWithAI} disabled={loading} className="flex-1 md:flex-none flex items-center justify-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors shadow-sm disabled:opacity-50">
                                {loading ? <Icons.Loader2 className="animate-spin" size={18} /> : <Icons.Sparkles size={18} />}
                                <span>Generate AI</span>
                            </button>
                            <button onClick={addRow} className="flex-1 md:flex-none flex items-center justify-center gap-2 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-50 transition-colors">
                                <Icons.Plus size={18} />
                                <span className="hidden sm:inline">Tambah Baris</span>
                            </button>
                            </div>
                        </div>

                        {error && (
                            <div className="mb-4 p-4 bg-red-50 text-red-700 rounded-lg flex items-center gap-2 text-sm border border-red-100">
                            <Icons.AlertCircle size={16} /> {error}
                            </div>
                        )}

                        <div className="overflow-x-auto border rounded-lg border-gray-200">
                            <table className="w-full text-sm text-left">
                            <thead className="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                                <tr>
                                <th className="px-4 py-3 min-w-[200px]">Kriteria / Indikator</th>
                                {formData.pendekatan === 'deskripsi' && <th className="px-4 py-3 min-w-[250px]">Deskripsi Kriteria Memadai</th>}
                                {formData.pendekatan === 'persentase' && <th className="px-4 py-3 min-w-[250px]">Keterangan (Opsional)</th>}
                                {formData.pendekatan === 'rubrik' && (
                                    <>
                                    <th className="px-4 py-3 min-w-[150px] bg-green-50">Mahir</th>
                                    <th className="px-4 py-3 min-w-[150px] bg-blue-50">Cakap</th>
                                    <th className="px-4 py-3 min-w-[150px] bg-yellow-50">Layak</th>
                                    <th className="px-4 py-3 min-w-[150px] bg-red-50">Baru Berkembang</th>
                                    </>
                                )}
                                {formData.pendekatan === 'interval' && <th className="px-4 py-3 min-w-[200px]">Catatan / Tindak Lanjut</th>}
                                <th className="px-2 py-3 w-[50px]">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {criteria.map((row) => (
                                <tr key={row.id} className="bg-white hover:bg-gray-50 group">
                                    <td className="p-3 align-top">
                                    <textarea value={row.text} onChange={(e) => handleCriteriaChange(row.id, 'text', e.target.value)} placeholder="Tulis indikator..." className="w-full p-2 border border-transparent hover:border-gray-300 focus:border-blue-500 rounded bg-transparent focus:bg-white transition-colors text-gray-800 resize-none h-24" />
                                    </td>
                                    {(formData.pendekatan === 'deskripsi' || formData.pendekatan === 'persentase') && (
                                    <td className="p-3 align-top">
                                        <textarea value={row.deskripsi_memadai} onChange={(e) => handleCriteriaChange(row.id, 'deskripsi_memadai', e.target.value)} placeholder="Deskripsi..." className="w-full p-2 border border-transparent hover:border-gray-300 focus:border-blue-500 rounded bg-transparent focus:bg-white transition-colors text-gray-600 resize-none h-24" />
                                    </td>
                                    )}
                                    {formData.pendekatan === 'rubrik' && (
                                    <>
                                        <td className="p-2 align-top bg-green-50/30">
                                        <textarea value={row.rubrik_mahir} onChange={(e) => handleCriteriaChange(row.id, 'rubrik_mahir', e.target.value)} className="w-full h-24 p-2 text-xs border border-transparent focus:border-green-400 rounded bg-transparent resize-none" placeholder="Sangat baik..." />
                                        </td>
                                        <td className="p-2 align-top bg-blue-50/30">
                                        <textarea value={row.rubrik_cakap} onChange={(e) => handleCriteriaChange(row.id, 'rubrik_cakap', e.target.value)} className="w-full h-24 p-2 text-xs border border-transparent focus:border-blue-400 rounded bg-transparent resize-none" placeholder="Sesuai..." />
                                        </td>
                                        <td className="p-2 align-top bg-yellow-50/30">
                                        <textarea value={row.rubrik_layak} onChange={(e) => handleCriteriaChange(row.id, 'rubrik_layak', e.target.value)} className="w-full h-24 p-2 text-xs border border-transparent focus:border-yellow-400 rounded bg-transparent resize-none" placeholder="Cukup..." />
                                        </td>
                                        <td className="p-2 align-top bg-red-50/30">
                                        <textarea value={row.rubrik_awal} onChange={(e) => handleCriteriaChange(row.id, 'rubrik_awal', e.target.value)} className="w-full h-24 p-2 text-xs border border-transparent focus:border-red-400 rounded bg-transparent resize-none" placeholder="Butuh bimbingan..." />
                                        </td>
                                    </>
                                    )}
                                    {formData.pendekatan === 'interval' && (
                                    <td className="p-3 align-top text-xs text-gray-500 italic">
                                        *Diisi manual (0-100).<br/>0-40%: Remedial Seluruh<br/>41-65%: Remedial Bagian<br/>66-85%: Tuntas<br/>86-100%: Pengayaan
                                    </td>
                                    )}
                                    <td className="p-3 align-top text-center">
                                    <button onClick={() => removeRow(row.id)} className="text-red-400 hover:text-red-600 p-1 hover:bg-red-50 rounded">
                                        <Icons.Trash2 size={16} />
                                    </button>
                                    </td>
                                </tr>
                                ))}
                            </tbody>
                            </table>
                        </div>
                        </div>
                    )}

                    {/* Step 4 */}
                    {step === 4 && (
                        <div className="p-8 bg-white print:p-0" ref={previewRef}>
                        <div className="border-b-2 border-black pb-4 mb-6 text-center print:border-black">
                            <h3 className="font-bold text-lg uppercase">{formData.sekolah}</h3>
                            <h2 className="font-bold text-xl uppercase">Instrumen Kriteria Ketercapaian Tujuan Pembelajaran (KKTP)</h2>
                            <p className="text-sm">Tahun Ajaran 2025/2026</p>
                        </div>

                        <div className="grid grid-cols-2 gap-x-8 gap-y-2 mb-6 text-sm">
                            <div className="flex"><span className="w-32 font-semibold">Nama Guru</span>: {formData.guru}</div>
                            <div className="flex"><span className="w-32 font-semibold">Kelas / Fase</span>: {formData.kelas} / {formData.fase}</div>
                            <div className="flex"><span className="w-32 font-semibold">Mata Pelajaran</span>: {formData.mapel}</div>
                            <div className="flex"><span className="w-32 font-semibold">Semester</span>: {formData.semester}</div>
                            <div className="col-span-2 mt-2">
                            <span className="font-semibold block mb-1">Capaian Pembelajaran (CP):</span>
                            <p className="text-justify leading-relaxed p-2 bg-gray-50 border border-gray-200 rounded print:border-none print:p-0 print:bg-transparent mb-2">{formData.cp || '-'}</p>
                            
                            <span className="font-semibold block mb-1">Tujuan Pembelajaran (TP):</span>
                            <p className="text-justify leading-relaxed p-2 bg-gray-50 border border-gray-200 rounded print:border-none print:p-0 print:bg-transparent">{formData.tp}</p>
                            </div>
                        </div>

                        <div className="mb-8">
                            <h4 className="font-bold mb-2 text-sm uppercase border-b border-gray-300 pb-1 w-fit">
                            Pendekatan: {formData.pendekatan === 'deskripsi' ? 'Deskripsi Kriteria' : formData.pendekatan === 'rubrik' ? 'Rubrik' : formData.pendekatan === 'interval' ? 'Interval Nilai' : 'Persentase'}
                            </h4>

                            <table className="w-full border-collapse border border-black text-sm">
                            <thead>
                                <tr className="bg-gray-100 print:bg-gray-200">
                                <th className="border border-black p-2 text-center w-10">No</th>
                                <th className="border border-black p-2 text-left">Kriteria / Indikator</th>
                                
                                {formData.pendekatan === 'deskripsi' && (
                                    <>
                                    <th className="border border-black p-2 w-24 text-center">Memadai</th>
                                    <th className="border border-black p-2 w-24 text-center">Tidak Memadai</th>
                                    </>
                                )}
                                {formData.pendekatan === 'rubrik' && (
                                    <>
                                    <th className="border border-black p-2 text-center w-1/5">Baru Berkembang</th>
                                    <th className="border border-black p-2 text-center w-1/5">Layak</th>
                                    <th className="border border-black p-2 text-center w-1/5">Cakap</th>
                                    <th className="border border-black p-2 text-center w-1/5">Mahir</th>
                                    </>
                                )}
                                {formData.pendekatan === 'interval' && (
                                    <>
                                    <th className="border border-black p-2 w-24 text-center">Nilai</th>
                                    <th className="border border-black p-2 text-left">Tindak Lanjut</th>
                                    </>
                                )}
                                {formData.pendekatan === 'persentase' && (
                                    <th className="border border-black p-2 w-24 text-center">Tercapai (Ya/Tidak)</th>
                                )}
                                </tr>
                            </thead>
                            <tbody>
                                {criteria.map((row, idx) => (
                                <tr key={row.id}>
                                    <td className="border border-black p-2 text-center">{idx + 1}</td>
                                    <td className="border border-black p-2">
                                    <div className="font-medium mb-1">{row.text}</div>
                                    {formData.pendekatan === 'deskripsi' && row.deskripsi_memadai && (
                                        <div className="text-xs text-gray-600 italic print:text-black">"{row.deskripsi_memadai}"</div>
                                    )}
                                    </td>
                                    {formData.pendekatan === 'deskripsi' && (
                                    <><td className="border border-black p-2"></td><td className="border border-black p-2"></td></>
                                    )}
                                    {formData.pendekatan === 'rubrik' && (
                                    <>
                                        <td className="border border-black p-2 text-xs align-top">{row.rubrik_awal || '-'}</td>
                                        <td className="border border-black p-2 text-xs align-top">{row.rubrik_layak || '-'}</td>
                                        <td className="border border-black p-2 text-xs align-top">{row.rubrik_cakap || '-'}</td>
                                        <td className="border border-black p-2 text-xs align-top font-semibold">{row.rubrik_mahir || '-'}</td>
                                    </>
                                    )}
                                    {formData.pendekatan === 'interval' && (
                                    <>
                                        <td className="border border-black p-2"></td>
                                        <td className="border border-black p-2 text-xs text-gray-400 print:hidden">Diisi manual</td>
                                        <td className="border border-black p-2 hidden print:table-cell"></td>
                                    </>
                                    )}
                                    {formData.pendekatan === 'persentase' && (
                                    <td className="border border-black p-2"></td>
                                    )}
                                </tr>
                                ))}
                            </tbody>
                            </table>
                            
                            {formData.pendekatan === 'deskripsi' && (
                            <div className="mt-4 text-xs">
                                <strong>Kesimpulan:</strong> Peserta didik mencapai TP jika minimal {Math.ceil(criteria.length * 0.75)} kriteria memadai.
                            </div>
                            )}
                            {formData.pendekatan === 'interval' && (
                            <div className="mt-4 text-xs border border-black p-2 w-2/3">
                                <strong>Keterangan Interval (PPA 2025):</strong>
                                <ul className="list-disc ml-4 mt-1">
                                <li>0 - 20% : Belum mencapai, remedial di seluruh bagian.</li>
                                <li>21 - 40% : Belum mencapai, remedial di bagian yang diperlukan.</li>
                                <li>41 - 60% : Belum mencapai, remedial di bagian yang diperlukan.</li>
                                <li>61 - 80% : Sudah mencapai ketuntasan.</li>
                                <li>81 - 100% : Sudah mencapai, perlu pengayaan.</li>
                                </ul>
                            </div>
                            )}
                            {formData.pendekatan === 'persentase' && (
                            <div className="mt-4 text-xs border border-black p-2 w-2/3">
                                <strong>Rumus:</strong> (Kriteria Tercapai / Total) x 100%. Contoh: (3/{criteria.length}) x 100% = {Math.round((3/criteria.length)*100)}%
                            </div>
                            )}
                        </div>
                        
                        <div className="flex justify-between mt-16 print:mt-10 px-8">
                            <div className="text-center w-64">
                            <p className="mb-20">Mengetahui,<br/>Kepala Sekolah</p>
                            <p className="font-bold underline">{formData.kepalaSekolah || '________________'}</p>
                            <p>NIP. {formData.nipKepalaSekolah || '..........................'}</p>
                            </div>

                            <div className="text-center w-64">
                            <p className="mb-20">....................., {new Date().toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}<br/>
                            {formData.jenisGuru === 'Guru Kelas' ? `Guru Kelas ${formData.kelas}` : 'Guru Mata Pelajaran'},
                            </p>
                            <p className="font-bold underline">{formData.guru || '________________'}</p>
                            <p>NIP. {formData.nipGuru || '..........................'}</p>
                            </div>
                        </div>
                        </div>
                    )}
                    </div>

                    <div className="mt-6 flex justify-between no-print">
                    <button onClick={() => setStep(prev => Math.max(1, prev - 1))} disabled={step === 1} className="flex items-center gap-2 px-6 py-3 rounded-lg bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed font-medium shadow-sm">
                        <Icons.ChevronLeft size={20} /> Kembali
                    </button>

                    {step < 4 ? (
                        <button onClick={() => setStep(prev => Math.min(4, prev + 1))} className="flex items-center gap-2 px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-medium shadow-lg hover:shadow-blue-500/30 transition-all">
                        Lanjut <Icons.ChevronRight size={20} />
                        </button>
                    ) : (
                        <div className="text-sm text-gray-500 italic flex items-center">
                        Siap dicetak atau disimpan.
                        </div>
                    )}
                    </div>

                </main>

                <footer className="bg-white border-t border-gray-200 py-8 mt-4 no-print">
                    <div className="max-w-5xl mx-auto px-4 text-center">
                        <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6 text-sm text-amber-900 max-w-3xl mx-auto flex gap-3 items-start text-left">
                            <Icons.AlertTriangle className="shrink-0 text-amber-600" size={20} />
                            <p><strong>Disclaimer:</strong> Aplikasi ini hanyalah sebuah alat bantu. Guru diharapkan memverifikasi dan menyesuaikan kembali kriteria sesuai kondisi peserta didik.</p>
                        </div>
                        <div className="text-gray-500 text-sm space-y-2">
                            <p className="font-medium text-gray-700">Â© 2026 Ryzaraccman</p>
                            <div className="flex items-center justify-center gap-2 hover:text-blue-600 transition-colors">
                                <Icons.Mail size={16} />
                                <a href="mailto:oryzanurracman17@gmail.com" className="hover:underline">Kontak Pengembang: oryzanurracman17@gmail.com</a>
                            </div>
                        </div>
                    </div>
                </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
